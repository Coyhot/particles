<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <meta charset="utf-8">
        <title>Particles</title>
        <style type="text/css">
            html {
                background: black;
                text-align: center;
            }
            body {
                width: 962px;
                margin: 20px auto;
                text-align: left;
            }
            #canvas {
                border: 1px solid #333;
            }
        </style>
    </head>
    <body>
        <canvas id="canvas" width="960" height="594"></canvas>
        <script type="text/javascript">
            var Particle = function(c, x, y, xVel, yVel, col) {
                this.c = canvas;
                this.ctx = this.c.getContext('2d');
                this.x = x;
                this.y = y;
                this.xVel = xVel || 0;
                this.yVel = yVel * -1 || 0;
                this.col = col || "rgba(255, 255, 255, 0.5)";
                
                return this;
            };
            
            Particle.prototype = {
                render: function() {
                    var c = this.c,
                        ctx = this.ctx,
                        drag = 0.999999,
                        gravity = 0.08,
                        bounceFriction = 0.6,
                        size = 2;
                    
                    ctx.fillStyle = this.col;
                    ctx.beginPath();
                    ctx.rect(this.x, this.y, size, size);
                    ctx.closePath();
                    ctx.fill();
                    
                    this.x += this.xVel;
                    this.y += this.yVel;
                    this.yVel += gravity;
                    this.xVel *= drag;
                    this.yVel *= drag;
                    
                    if (this.x > c.width || this.x < 0) {
                        this.xVel *= -bounceFriction;
                    }
                    
                    if (this.y > c.height || this.y < 0) {
                        this.yVel *= -bounceFriction;
                    }
                }
            };
            
            
            var canvasController = function(){
                var id = 'canvas',
                    c = document.getElementById(id),
                    ctx = c.getContext('2d'),
                    cw = c.width,
                    cminw = c.offsetLeft,
                    cmaxw = cminw + cw,
                    ch = c.height,
                    cminh = c.offsetTop,
                    cmaxh = cminh + ch,
                    mousex,
                    mousey,
                    refreshRate = 10,
                    limit = 500,
                    count = 0,
                    particles = new Array(limit);
                    
                return o = {
                    init: function() {
                        document.body.onmousemove = o.updateMouseCoords;
                        return setInterval(o.refresh, refreshRate);
                    },
                    
                    rand: function(max, min) {
                        return Math.random() * (max - min) + min;
                    },
                    
                    updateMouseCoords: function(e) {
                        if (e.pageX > cminw && e.pageX < cmaxw) {
                            mousex = e.pageX - cminw;
                        }
                        
                        if (e.pageY > cminh && e.pageY < cmaxh) {
                            mousey = e.pageY - cminh;
                        }
                    },
                    
                    refresh: function() {
                        ctx.fillStyle = "rgba(0, 0, 0, 0.15)";
                        ctx.fillRect(0, 0, cw, ch);
                        // ctx.clearRect(0, 0, cw, ch);
                        
                        if (count > limit) {
                            count = 0;
                        }
                        console.log(mousex + ', ' + mousey);
                        particles[count++] = new Particle(
                            c,
                            // cw/2,
                            // ch/2,
                            mousex,
                            mousey,
                            o.rand(3, -3),
                            o.rand(3, 2),
                            [
                                "rgba(",
                                Math.floor(o.rand(255, 125)),
                                ", ",
                                Math.floor(o.rand(255, 125)),
                                ", ",
                                Math.floor(o.rand(255, 125)),
                                ", 0.75)"
                            ].join('')
                        );
                        
                        for (var i in particles) {
                            var p = particles[i];
                            
                            p.render();
                            
                            if (p.y > c.ch) {
                                delete particles[i];
                            }
                        }
                    }
                };
            }();
            
            var inter = canvasController.init();
        </script>
    </body>
</html>